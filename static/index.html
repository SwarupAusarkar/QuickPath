<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
      }
    </script>
  <title>URL Shortener</title>
</head>
<body class="bg-gradient-to-br from-teal-100 to-blue-100 dark:from-gray-900 dark:to-gray-800 text-gray-800 dark:text-gray-100 min-h-screen flex items-center justify-center font-sans relative overflow-hidden">

    <button onclick="toggleTheme()" class="fixed top-6 right-6 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 border border-gray-300 dark:border-gray-700 px-3 py-2 rounded-full shadow hover:scale-110 transition-all">
        <span id="theme-icon">ðŸŒž</span>
    </button>      

    <div class="bg-white/90 dark:bg-gray-900/80 backdrop-blur-md border border-teal-200 dark:border-gray-700 p-8 rounded-3xl shadow-xl dark:shadow-[0_4px_30px_rgba(0,0,0,0.5)] w-full max-w-xl animate-fade-in text-gray-800 dark:text-gray-100 relative">
        <h1 class="text-4xl font-bold text-center mb-8 text-teal-600 dark:text-teal-400">ðŸ”— Shorten Your URL</h1>
      
        <div class="space-y-6">
          <!-- Long URL -->
          <div class="relative">
            <input id="long-url" type="text" class="peer w-full p-4 bg-white text-gray-700 dark:bg-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-600 rounded-xl outline-none focus:ring-2 focus:ring-teal-400" placeholder="Long URL">
          </div>
      
          <!-- Custom URL -->
          <div class="relative">
            <input id="custom-url" type="text" class="peer w-full p-4 bg-white text-gray-700 dark:bg-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-600 rounded-xl outline-none focus:ring-2 focus:ring-teal-400" placeholder="Custom Short URL (optional)">
          </div>
      
          <!-- Shorten Button -->
          <button id="shorten-btn" onclick="shortenUrl()" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-semibold py-3 rounded-xl transition-all duration-300 shadow-md hover:shadow-lg hover:scale-105 dark:bg-teal-600 dark:hover:bg-teal-700 disabled:opacity-50 disabled:cursor-not-allowed">
            Shorten
          </button>
    </div>
    <div id="result" class="mt-6 text-center text-lg font-medium text-teal-700 dark:text-teal-300"></div>
    <div id="error" class="mt-2 text-center text-red-500 dark:text-red-400"></div>

<!-- Copy Button -->
<div id="copy-btn" class="hidden mt-4 flex justify-center">
    <button onclick="copyToClipboard()" class="bg-teal-100 dark:bg-gray-800 dark:text-teal-300 text-teal-800 px-6 py-2 rounded-xl shadow hover:shadow-md transition">
      ðŸ“‹ Copy
    </button>
  </div>
  
  <!-- Toast (Moved outside the card) -->
  <div id="toast" class="absolute top-full mt-4 left-1/2 transform -translate-x-1/2 bg-teal-500 dark:bg-teal-600 text-white px-6 py-3 rounded-2xl shadow-xl opacity-0 transition-all scale-90 z-50">
    Copied to clipboard!
  </div>
  </div>      

  <script>
    if (
      localStorage.getItem('theme') === 'dark' ||
      (!localStorage.getItem('theme') &&
        window.matchMedia('(prefers-color-scheme: dark)').matches)
    ) {
      document.documentElement.classList.add('dark');
    }
  
    window.addEventListener('DOMContentLoaded', () => {
      const icon = document.getElementById('theme-icon');
      const currentTheme = localStorage.getItem('theme');
      icon.textContent = currentTheme === 'dark' ? 'ðŸŒš' : 'ðŸŒž';
    });
  
    function toggleTheme() {
      const html = document.documentElement;
      const icon = document.getElementById('theme-icon');
  
      if (html.classList.contains('dark')) {
        html.classList.remove('dark');
        localStorage.setItem('theme', 'light');
        icon.textContent = 'ðŸŒž';
      } else {
        html.classList.add('dark');
        localStorage.setItem('theme', 'dark');
        icon.textContent = 'ðŸŒš';
      }
    }

    // Function to validate URL format
    function isValidUrl(url) {
      const urlPattern = new RegExp(
        "^(https?:\\/\\/)?" + // Protocol (http or https)
        "((([a-zA-Z0-9\\-]+\\.)+[a-zA-Z]{2,})|" + // Domain name
        "localhost|" + // Localhost
        "\\d{1,3}(\\.\\d{1,3}){3})" + // OR IPv4
        "(\\:\\d+)?(\\/[-a-zA-Z0-9@:%_+.~#?&//=]*)?$", // Port and path
        "i"
      );
      return urlPattern.test(url);
    }
  
    async function shortenUrl() {
      const originalUrl = document.getElementById('long-url').value.trim();
      const customShort = document.getElementById('custom-url').value.trim();
      const resultDiv = document.getElementById('result');
      const errorDiv = document.getElementById('error');
      const copyBtn = document.getElementById('copy-btn');
      const shortenBtn = document.getElementById('shorten-btn');

      resultDiv.textContent = '';
      errorDiv.textContent = '';
      copyBtn.classList.add('hidden');

      // Validate the long URL
      if (!originalUrl) {
        errorDiv.textContent = 'Please enter a long URL.';
        return;
      }

      if (!isValidUrl(originalUrl)) {
        errorDiv.textContent = 'Invalid URL format. Please enter a valid URL (e.g., https://example.com).';
        return;
      }

      shortenBtn.disabled = true;
      shortenBtn.textContent = 'Shortening...';

      try {
        const response = await fetch('/shorten', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            original_url: originalUrl,
            custom_short: customShort === '' ? null : customShort
          })
        });

        const data = await response.json();
        document.getElementById('long-url').value = "";
        document.getElementById('custom-url').value = "";

        if (!response.ok) {
          if (response.status === 400 && data.detail === "Short URL already exists, please choose another one") {
            errorDiv.textContent = "The custom short URL already exists. Please try a different one.";
          } else {
            errorDiv.textContent = data.detail || 'Something went wrong. Please try again.';
          }
        } else {
          resultDiv.innerHTML = `<a href="${data.short_url}" target="_blank" class="underline text-teal-600 dark:text-teal-300">${data.short_url}</a>`;
          copyBtn.classList.remove('hidden');
          copyBtn.dataset.url = data.short_url;
        }
      } catch (err) {
        errorDiv.textContent = 'Failed to connect to the server. Please check your internet connection.';
      } finally {
        shortenBtn.disabled = false;
        shortenBtn.textContent = 'Shorten';
      }
    }

    function copyToClipboard() {
      const url = document.getElementById('copy-btn').dataset.url;
      navigator.clipboard.writeText(url).then(() => {
        const toast = document.getElementById('toast');
        toast.classList.remove('opacity-0', 'scale-90');
        toast.classList.add('opacity-100', 'scale-100', 'animate-pop');

        setTimeout(() => {
          toast.classList.remove('opacity-100', 'scale-100');
          toast.classList.add('opacity-0', 'scale-90');
        }, 2000);
      });
    }
  </script>

  <style>
    /* Toast Animation */
    @keyframes fade-in {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
  
    @keyframes pop-in {
      0% {
        transform: scale(0.8);
        opacity: 0;
      }
      60% {
        transform: scale(1.1);
        opacity: 1;
      }
      100% {
        transform: scale(1);
      }
    }
  
    .animate-fade-in {
      animation: fade-in 0.6s ease-out forwards;
    }
  
    .animate-pop {
      animation: pop-in 0.3s ease-out;
    }
  
    /* Toast Position Adjustment */
    #toast {
      position: absolute;
      top: 100%;
      margin-top: 1rem; 
    }
  
    /* Copy Button Fix */
    #copy-btn button {
      width: auto;
      cursor: pointer;
    }
  </style>
</body>
</html>